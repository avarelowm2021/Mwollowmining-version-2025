<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Étiquettes Mwolloccaz avec QR Code et Image</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #eef;
    }
    label, input, textarea, button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
    }
  </style>
</head>
<body>

  <h2>Générateur d’étiquettes Mwolloccaz</h2>

  <label for="clause">Clause d'achat :</label>
  <textarea id="clause" rows="4">Cet article est vendu en l’état, sans garantie.</textarea>

  <label for="qrText">Contenu du QR Code :</label>
  <input type="text" id="qrText" value="https://exemple.com/article/1234" />

  <label for="nb">Nombre d’étiquettes :</label>
  <input type="number" id="nb" value="6" min="1" max="60" />

  <label for="nom">Nom :</label>
  <input type="text" id="nom" value="Dupont" />

  <label for="prenom">Prénom :</label>
  <input type="text" id="prenom" value="Jean" />

  <label for="imageUpload">Image à ajouter :</label>
  <input type="file" id="imageUpload" accept="image/*" />

  <button onclick="generatePDF()">Télécharger le PDF</button>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const clause = document.getElementById('clause').value.trim();
      const qrText = document.getElementById('qrText').value.trim();
      const nb = parseInt(document.getElementById('nb').value);
      const nom = document.getElementById('nom').value.trim();
      const prenom = document.getElementById('prenom').value.trim();

      const canvas = document.getElementById("canvas");

      await QRCode.toCanvas(canvas, qrText, { width: 100 });
      const qrImg = canvas.toDataURL("image/png");

      const imageInput = document.getElementById("imageUpload");
      let userImage = null;
      if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        const imageLoaded = new Promise((resolve) => {
          reader.onload = function (e) {
            userImage = e.target.result;
            resolve();
          };
        });
        reader.readAsDataURL(imageInput.files[0]);
        await imageLoaded;
      }

      const positions = [
        [15, 20], [110, 20],
        [15, 110], [110, 110],
        [15, 200], [110, 200]
      ];

      for (let i = 0; i < nb; i++) {
        const positionIndex = i % 2;
        if (positionIndex === 0 && i > 0) doc.addPage();

        const [x, y] = positions[positionIndex];

        doc.setFontSize(12);
        doc.text("Mwolloccaz clause", x, y);

        doc.setFontSize(10);
        const wrappedText = doc.splitTextToSize(clause, 80);
        const lineHeight = 5;
        const textStartY = y + 10;
        const textEndY = textStartY + wrappedText.length * lineHeight;

        doc.text(wrappedText, x, textStartY);

        const qrY = textEndY + 5;
        doc.addImage(qrImg, "PNG", x, qrY, 40, 40);

        if (userImage) {
          doc.addImage(userImage, "PNG", x + 45, qrY, 40, 40);
        }

        // Ajout du nom, prénom et signature
        const signatureY = qrY + 50;
        doc.setFontSize(10);
        doc.text(`Nom : ${nom}`, x, signatureY);
        doc.text(`Prénom : ${prenom}`, x, signatureY + 5);
        doc.text("Signature : ___________________________", x, signatureY + 10);
      }

      doc.save("etiquettes-mwolloccaz.pdf");
    }
  </script>

</body>
</html>
