<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VERITESURLOWM - Token avec QR</title>
  <style>
    body {
      background-color: white;
      color: black;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    h1 { font-size: 2em; }
    input, button {
      font-size: 1.1em;
      padding: 8px 15px;
      margin: 8px;
    }
    #qrcode {
      margin-top: 20px;
      display: inline-block;
      background: white;
      padding: 10px;
      border: 2px solid black;
    }
    canvas {
      margin-top: 20px;
      border: 1px solid #ccc;
    }
    .btn {
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover { background-color: #27ae60; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>//v//v//W\\v\\v\\</h1>

<!-- Conversion et g√©n√©ration -->
<div>
  <label for="inputValue">Entrez un chiffre pour convertir en NA1C142 :</label><br>
  <input type="text" id="inputValue" placeholder="Ex: 142"><br>
  <button class="btn" onclick="convertToLetters()">Convertir et G√©n√©rer QR Code</button>
</div>

<!-- R√©sultat conversion -->
<div id="result" style="margin:10px; font-weight:bold;"></div>

<!-- QR code affich√© + boutons -->
<div id="qrcode"></div><br>
<button id="copyQR" class="btn">üìã Copier le QR Code</button>
<button id="copyToken" class="btn">üìã Copier le Token Modifi√©</button>
<button id="downloadPNG" class="btn">üì• T√©l√©charger PNG</button>
<button id="downloadPDF" class="btn">üì• T√©l√©charger PDF</button>

<!-- Import du billet -->
<br><br>
<label for="imageUpload">T√©l√©chargez l'image du token type 2 :</label><br>
<input type="file" id="imageUpload" accept="image/*"><br><br>

<!-- Canvas -->
<canvas id="canvas" width="1760" height="720"></canvas>
<br>

<!-- Contr√¥les QR -->
<button id="savePos" class="btn">Sauvegarder position du QR</button>
<button id="zoomIn" class="btn">+ Agrandir QR</button>
<button id="zoomOut" class="btn">- R√©duire QR</button>

<p id="posDisplay"></p>

<script>
  const { jsPDF } = window.jspdf;

  let qrCodeCanvas = null;
  let qrX = 780;
  let qrY = 180;
  let qrSize = 220;
  let dragging = false;
  let offsetX, offsetY;

  let lastFullData = ""; // sauvegarde du texte complet

  // === Table de conversion NA1C142 ===
  const alphabet = {
    1: 'Aso', 2: 'Bbebe', 3: 'Cco', 4: 'Dtri', 5: 'Ees',
    6: 'Fange', 7: 'Gfard', 8: 'Hbrivol', 9: 'Iinfi', 10: 'Jsauv',
    11: 'Kfeu', 12: 'Lcieux', 13: 'Msang', 14: 'Nan', 15: 'Oben',
    16: 'Pcube', 17: 'Qhein', 18: 'Rcoup', 19: 'Spur', 20: 'Tsouf',
    21: 'Ulien', 22: 'Vdiv', 23: 'Wfoch', 24: 'Xind', 25: 'Ychoix',
    26: 'Zlev'
  };

  // Conversion chiffre -> lettres + date/heure
  function convertToLetters() {
    let inputValue = document.getElementById('inputValue').value;
    let result = "";

    if (/^\d+$/.test(inputValue)) {
      let num = parseInt(inputValue);
      while (num > 0) {
        let digit = num % 26;
        if (digit === 0) digit = 26;
        result = alphabet[digit] + result;
        num = (num - digit) / 26;
      }

      let now = new Date();
      let date = now.toLocaleDateString("fr-FR");
      let time = now.toLocaleTimeString("fr-FR");

      lastFullData = result + "\nDate: " + date + "\nHeure: " + time;

      document.getElementById('result').innerText = "Conversion : " + result;
      generateQRCode(lastFullData);

    } else {
      document.getElementById('result').innerText = "Veuillez entrer un nombre valide";
    }
  }

  // G√©n√©ration QR
  function generateQRCode(text) {
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), {
      text: text,
      width: 200,
      height: 200,
      colorDark: "#000000",
      colorLight: "#FFFFFF",
      correctLevel: QRCode.CorrectLevel.H
    });

    setTimeout(() => {
      qrCodeCanvas = document.querySelector('#qrcode canvas');
      redrawCanvas();
    }, 300);
  }

  // Copier le QR en image dans le presse-papiers
  document.getElementById("copyQR").addEventListener("click", async function() {
    let qrCanvas = document.querySelector("#qrcode canvas");
    if (qrCanvas) {
      qrCanvas.toBlob(async (blob) => {
        try {
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob })
          ]);
          alert("‚úÖ QR Code copi√© dans le presse-papiers !");
        } catch (err) {
          alert("‚ùå Impossible de copier (navigateur non compatible).");
        }
      });
    }
  });

  // Copier le token modifi√© (canvas entier)
  document.getElementById("copyToken").addEventListener("click", async function() {
    let canvas = document.getElementById("canvas");
    canvas.toBlob(async (blob) => {
      try {
        await navigator.clipboard.write([
          new ClipboardItem({ "image/png": blob })
        ]);
        alert("‚úÖ Token modifi√© copi√© dans le presse-papiers !");
      } catch (err) {
        alert("‚ùå Impossible de copier (navigateur non compatible).");
      }
    });
  });

  // T√©l√©charger en PNG
  document.getElementById("downloadPNG").addEventListener("click", function() {
    let canvas = document.getElementById("canvas");
    let link = document.createElement("a");
    link.download = "token.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });

  // T√©l√©charger en PDF
  document.getElementById("downloadPDF").addEventListener("click", function() {
    let canvas = document.getElementById("canvas");
    let imgData = canvas.toDataURL("image/png");

    let pdf = new jsPDF("l", "pt", [canvas.width, canvas.height + 200]);

    // Image du token
    pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);

    // Ajout du texte
    pdf.setFont("courier", "normal");
    pdf.setFontSize(16);
    let lines = lastFullData.split("\n");
    for (let i = 0; i < lines.length; i++) {
      pdf.text(lines[i], 40, canvas.height + 40 + (i * 25));
    }

    pdf.save("token.pdf");
  });

  // Upload du billet
  document.getElementById('imageUpload').addEventListener('change', function(event) {
    let file = event.target.files[0];
    let reader = new FileReader();

    reader.onload = function(e) {
      let img = new Image();
      img.onload = function() {
        let canvas = document.getElementById('canvas');
        canvas.width = 1760;
        canvas.height = 720;
        canvas.tokenImage = img;
        redrawCanvas();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  // Redessine le canvas
  function redrawCanvas() {
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (canvas.tokenImage) {
      ctx.drawImage(canvas.tokenImage, 0, 0, canvas.width, canvas.height);
    }
    if (qrCodeCanvas) {
      // QR
      ctx.drawImage(qrCodeCanvas, qrX, qrY, qrSize, qrSize);

      // Cadre autour du QR
      ctx.strokeStyle = "red";
      ctx.lineWidth = 3;
      ctx.strokeRect(qrX, qrY, qrSize, qrSize);

      // Texte sous le QR
      if (lastFullData) {
        ctx.font = "20px monospace";
        ctx.fillStyle = "black";
        let lines = lastFullData.split("\n");
        for (let i = 0; i < lines.length; i++) {
          ctx.fillText(lines[i], qrX, qrY + qrSize + 30 + (i * 25));
        }
      }
    }
  }

  // Drag & drop
  let canvas = document.getElementById('canvas');
  canvas.addEventListener("mousedown", function(e) {
    if (!qrCodeCanvas) return;
    let rect = canvas.getBoundingClientRect();
    let mouseX = e.clientX - rect.left;
    let mouseY = e.clientY - rect.top;

    if (mouseX >= qrX && mouseX <= qrX + qrSize &&
        mouseY >= qrY && mouseY <= qrY + qrSize) {
      dragging = true;
      offsetX = mouseX - qrX;
      offsetY = mouseY - qrY;
    }
  });

  canvas.addEventListener("mousemove", function(e) {
    if (dragging) {
      let rect = canvas.getBoundingClientRect();
      qrX = e.clientX - rect.left - offsetX;
      qrY = e.clientY - rect.top - offsetY;
      redrawCanvas();
    }
  });

  canvas.addEventListener("mouseup", function() { dragging = false; });
  canvas.addEventListener("mouseleave", function() { dragging = false; });

  // Sauvegarde position
  document.getElementById("savePos").addEventListener("click", function() {
    document.getElementById("posDisplay").innerHTML =
      `Position actuelle du QR ‚Üí X: <b>${qrX}</b>, Y: <b>${qrY}</b>, Taille: <b>${qrSize}</b>`;
  });

  // Redimensionnement QR
  document.getElementById("zoomIn").addEventListener("click", function() {
    qrSize += 20;
    redrawCanvas();
  });

  document.getElementById("zoomOut").addEventListener("click", function() {
    if (qrSize > 40) {
      qrSize -= 20;
      redrawCanvas();
    }
  });
</script>

</body>
</html>
